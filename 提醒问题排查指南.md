# 提醒功能问题排查指南

## 🔍 问题：设置了提醒但没有收到提醒

### 快速检查清单

1. ✅ **检查 Logcat 日志**
2. ✅ **检查权限是否授予**
3. ✅ **检查提醒时间是否已过期**
4. ✅ **检查设备省电模式**
5. ✅ **测试提醒功能**

---

## 📋 详细排查步骤

### 步骤 1：查看 Logcat 日志

**操作**：
1. 在 Android Studio 中打开 Logcat
2. 过滤标签：`AlarmHelper`、`AlarmReceiver`、`NotificationHelper`
3. 添加提醒后查看日志

**应该看到的日志**：
```
AlarmHelper: Setting alarm - Date: 2025-01-15, Time: 14:30
AlarmHelper: Reminder time (before subtracting): Wed Jan 15 14:30:00 CST 2025
AlarmHelper: Alarm will trigger at: Wed Jan 15 14:25:00 CST 2025
AlarmHelper: Current time: Wed Jan 15 14:20:00 CST 2025
AlarmHelper: Time difference: 300 seconds (5 minutes)
AlarmHelper: ✓ Alarm successfully set for reminder: xxx
```

**如果看到这些日志，说明提醒已设置成功**

**如果看到这些错误**：
- `Alarm time is in the past` → 提醒时间已过期
- `Cannot schedule exact alarms` → 需要用户授权
- `Reminder notification is disabled` → 提醒未启用

---

### 步骤 2：检查权限

#### Android 13+ (API 33+)

**检查通知权限**：
1. 打开应用
2. 首次添加提醒时会弹出权限请求
3. 如果拒绝了，需要手动授予：
   - 设置 → 应用 → Calendar → 通知 → 允许

**检查精确提醒权限**：
1. 设置 → 应用 → Calendar → 权限
2. 找到"使用精确提醒"或"Schedule exact alarms"
3. 确保已开启

#### 所有 Android 版本

**检查省电模式**：
1. 设置 → 电池 → 省电模式
2. 确保应用不在省电限制列表中
3. 某些设备需要将应用加入"白名单"

---

### 步骤 3：检查提醒时间

**常见问题**：
- 提醒时间设置为过去的时间
- 提前时间设置过大，导致提醒时间已过期

**解决方法**：
1. 设置提醒时间为当前时间 + 至少 1 分钟
2. 如果提前时间设置为 5 分钟，确保：
   - 开始时间 - 5 分钟 > 当前时间

**示例**：
- 当前时间：14:20
- 开始时间：14:30
- 提前时间：5 分钟
- 提醒时间：14:25 ✓（有效）

- 当前时间：14:20
- 开始时间：14:22
- 提前时间：5 分钟
- 提醒时间：14:17 ✗（已过期）

---

### 步骤 4：测试提醒功能

#### 方法 1：使用调试工具

在 `MainActivity.onCreate()` 中添加：

```java
// 测试提醒（1分钟后触发）
AlarmDebugHelper.testAlarm(this);

// 查看所有提醒状态
AlarmDebugHelper.debugAllReminders(this);
```

#### 方法 2：手动测试

1. **添加测试提醒**：
   - 日期：今天
   - 开始时间：当前时间 + 1 分钟（如现在是 14:30，设置为 14:31）
   - 提前时间：0 分钟（立即提醒）
   - 启用提醒：✓

2. **等待 1 分钟**，应该收到通知

3. **如果收到通知**：
   - ✓ 提醒功能正常
   - 检查之前设置的提醒时间是否正确

4. **如果没收到通知**：
   - 查看 Logcat 日志
   - 检查权限
   - 检查设备设置

---

### 步骤 5：检查设备设置

#### 小米/华为/OPPO/VIVO 等国产手机

**需要特殊设置**：
1. **自启动管理**：
   - 设置 → 应用 → Calendar → 自启动 → 开启

2. **后台运行**：
   - 设置 → 应用 → Calendar → 后台运行 → 允许

3. **省电优化**：
   - 设置 → 电池 → 应用省电管理 → Calendar → 无限制

4. **通知管理**：
   - 设置 → 通知 → Calendar → 允许通知

#### 通用设置

1. **勿扰模式**：
   - 确保未开启勿扰模式

2. **静音模式**：
   - 确保设备未静音

3. **应用通知设置**：
   - 设置 → 应用 → Calendar → 通知
   - 确保"允许通知"已开启
   - 确保"提醒通知"渠道已启用

---

## 🐛 常见错误及解决方法

### 错误 1：`Alarm time is in the past`

**原因**：提醒时间已过期

**解决方法**：
- 设置提醒时间为未来时间
- 减少提前时间

---

### 错误 2：`Cannot schedule exact alarms`

**原因**：Android 12+ 需要用户手动授权精确提醒权限

**解决方法**：
1. 打开设置 → 应用 → Calendar → 权限
2. 找到"使用精确提醒"或"Schedule exact alarms"
3. 开启权限

**代码中已添加检查**，如果权限未授予会在日志中提示。

---

### 错误 3：`Reminder notification is disabled`

**原因**：提醒开关未打开

**解决方法**：
- 添加提醒时确保"🔔 Enable System Reminder"开关已打开

---

### 错误 4：收到提醒但没有声音

**原因**：
- 设备静音
- 通知渠道声音未设置
- 通知优先级过低

**解决方法**：
1. 检查设备音量
2. 检查通知渠道设置（代码中已设置为 HIGH 优先级）
3. 确保通知渠道声音已设置

---

### 错误 5：应用重启后提醒失效

**原因**：应用重启后 AlarmManager 中的提醒会丢失

**解决方法**：
- 代码中已在 `onCreate()` 中调用 `restoreAllAlarms()`
- 确保应用启动时正确恢复了提醒

---

## 🔧 调试技巧

### 1. 添加详细日志

所有关键步骤都已添加日志，查看 Logcat 即可：

```bash
# 过滤标签
AlarmHelper
AlarmReceiver
NotificationHelper
AlarmDebug
```

### 2. 使用调试工具

```java
// 在 MainActivity 中添加
AlarmDebugHelper.debugAllReminders(this);  // 查看所有提醒
AlarmDebugHelper.testAlarm(this);          // 测试提醒
```

### 3. 检查提醒状态

```java
// 检查提醒是否启用
if (reminder.isEnableNotification()) {
    Log.d(TAG, "Reminder notification is enabled");
}

// 检查提醒时间
Log.d(TAG, "Reminder date: " + reminder.getDate());
Log.d(TAG, "Reminder time: " + reminder.getStartTime());
Log.d(TAG, "Minutes before: " + reminder.getNotificationMinutesBefore());
```

---

## ✅ 验证清单

在报告问题前，请确认：

- [ ] 已查看 Logcat 日志
- [ ] 通知权限已授予（Android 13+）
- [ ] 精确提醒权限已授予（Android 12+）
- [ ] 提醒时间设置为未来时间
- [ ] 提醒开关已打开
- [ ] 设备未处于省电模式
- [ ] 应用已加入后台运行白名单（国产手机）
- [ ] 设备未静音
- [ ] 通知渠道已启用

---

## 📞 如果问题仍然存在

1. **收集日志**：
   - 复制 Logcat 中的 `AlarmHelper`、`AlarmReceiver`、`NotificationHelper` 日志
   - 包含设置提醒时的完整日志

2. **提供信息**：
   - Android 版本
   - 设备型号
   - 提醒设置的日期和时间
   - 提前时间设置

3. **测试步骤**：
   - 描述你设置提醒的步骤
   - 描述你等待的时间
   - 是否收到任何通知

---

## 🎯 快速测试方法

**最简单的测试**：
1. 打开应用
2. 添加提醒：
   - 日期：今天
   - 时间：当前时间 + 2 分钟
   - 提前时间：0 分钟
   - 启用提醒：✓
3. 保存提醒
4. 查看 Logcat，应该看到：
   ```
   AlarmHelper: ✓ Alarm successfully set
   ```
5. 等待 2 分钟
6. 应该收到通知

**如果这个测试都失败，说明是权限或设备设置问题。**

